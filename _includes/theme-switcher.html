<!-- ä¸»é¢˜åˆ‡æ¢å™¨ç»„ä»¶ -->
<div class="theme-switcher" id="themeSwitcher">
    <!-- æ·±è‰²æ¨¡å¼ -->
    <button class="theme-toggle-btn active" onclick="setTheme('dark')" title="æ·±è‰²æ¨¡å¼" data-theme="dark">
        <i class="fas fa-moon"></i>
    </button>
    <div class="theme-name">æ·±è‰²æ¨¡å¼</div>
    
    <!-- æµ…è‰²é˜…è¯»æ¨¡å¼ -->
    <button class="theme-toggle-btn" onclick="setTheme('light')" title="æµ…è‰²é˜…è¯»æ¨¡å¼" data-theme="light">
        <i class="fas fa-sun"></i>
    </button>
    <div class="theme-name">æµ…è‰²é˜…è¯»</div>
    
    <!-- æŠ¤çœ¼æ¨¡å¼ -->
    <button class="theme-toggle-btn" onclick="setTheme('eye-care')" title="æŠ¤çœ¼æ¨¡å¼" data-theme="eye-care">
        <i class="fas fa-leaf"></i>
    </button>
    <div class="theme-name">æŠ¤çœ¼æ¨¡å¼</div>
    
    <!-- æš–è‰²æ¨¡å¼ -->
    <button class="theme-toggle-btn" onclick="setTheme('warm')" title="æš–è‰²æ¨¡å¼" data-theme="warm">
        <i class="fas fa-fire"></i>
    </button>
    <div class="theme-name">æš–è‰²æ¨¡å¼</div>
    
    <!-- é«˜å¯¹æ¯”åº¦æ¨¡å¼ -->
    <button class="theme-toggle-btn" onclick="setTheme('high-contrast')" title="é«˜å¯¹æ¯”åº¦æ¨¡å¼" data-theme="high-contrast">
        <i class="fas fa-adjust"></i>
    </button>
    <div class="theme-name">é«˜å¯¹æ¯”åº¦</div>
</div>

<script>
// ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
class ThemeSwitcher {
    constructor() {
        this.currentTheme = 'dark'; // é»˜è®¤ä¸»é¢˜
        this.init();
    }
    
    init() {
        // ä»localStorageè¯»å–ä¿å­˜çš„ä¸»é¢˜
        const savedTheme = localStorage.getItem('blog-theme');
        if (savedTheme) {
            this.setTheme(savedTheme);
        } else {
            // æ£€æµ‹ç³»ç»Ÿä¸»é¢˜åå¥½
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                this.setTheme('light');
            }
        }
        
        // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: light)').addEventListener('change', (e) => {
                if (!localStorage.getItem('blog-theme')) {
                    this.setTheme(e.matches ? 'light' : 'dark');
                }
            });
        }
        
        // ä¸ºæ¯ä¸ªä¸»é¢˜æŒ‰é’®æ·»åŠ æ‚¬åœæç¤º
        this.addHoverEffects();
    }
    
    setTheme(themeName) {
        // æ›´æ–°HTMLå±æ€§
        document.documentElement.setAttribute('data-theme', themeName);
        
        // æ›´æ–°å½“å‰ä¸»é¢˜
        this.currentTheme = themeName;
        
        // ä¿å­˜åˆ°localStorage
        localStorage.setItem('blog-theme', themeName);
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        this.updateButtonStates(themeName);
        
        // æ˜¾ç¤ºåˆ‡æ¢æç¤º
        this.showThemeNotification(themeName);
        
        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œè®©å…¶ä»–ç»„ä»¶çŸ¥é“ä¸»é¢˜å·²åˆ‡æ¢
        window.dispatchEvent(new CustomEvent('themeChanged', { 
            detail: { theme: themeName } 
        }));
    }
    
    updateButtonStates(activeTheme) {
        const buttons = document.querySelectorAll('.theme-toggle-btn');
        buttons.forEach(btn => {
            btn.classList.remove('active');
            if (btn.getAttribute('data-theme') === activeTheme) {
                btn.classList.add('active');
            }
        });
    }
    
    addHoverEffects() {
        const buttons = document.querySelectorAll('.theme-toggle-btn');
        buttons.forEach(btn => {
            btn.addEventListener('mouseenter', (e) => {
                const themeName = e.target.getAttribute('data-theme');
                this.previewTheme(themeName);
            });
            
            btn.addEventListener('mouseleave', () => {
                this.previewTheme(this.currentTheme);
            });
        });
    }
    
    previewTheme(themeName) {
        // ä¸´æ—¶é¢„è§ˆä¸»é¢˜ï¼ˆé¼ æ ‡æ‚¬åœæ—¶ï¼‰
        document.documentElement.style.transition = 'all 0.3s ease';
        document.documentElement.setAttribute('data-theme', themeName);
        
        setTimeout(() => {
            document.documentElement.style.transition = '';
        }, 300);
    }
    
    showThemeNotification(themeName) {
        const themes = {
            'dark': { name: 'æ·±è‰²æ¨¡å¼', icon: 'ğŸŒ™', desc: 'ç»å…¸æ·±è‰²ä¸»é¢˜ï¼Œé€‚åˆå¤œé—´ä½¿ç”¨' },
            'light': { name: 'æµ…è‰²é˜…è¯»', icon: 'â˜€ï¸', desc: 'æ¸…çˆ½æµ…è‰²èƒŒæ™¯ï¼Œé€‚åˆç™½å¤©é˜…è¯»' },
            'eye-care': { name: 'æŠ¤çœ¼æ¨¡å¼', icon: 'ğŸƒ', desc: 'æ·¡ç»¿è‰²èƒŒæ™¯ï¼Œå‡å°‘çœ¼éƒ¨ç–²åŠ³' },
            'warm': { name: 'æš–è‰²æ¨¡å¼', icon: 'ğŸ”¥', desc: 'æ¸©æš–ç±³è‰²èƒŒæ™¯ï¼Œè¥é€ èˆ’é€‚æ°›å›´' },
            'high-contrast': { name: 'é«˜å¯¹æ¯”åº¦', icon: 'âš«', desc: 'é«˜å¯¹æ¯”åº¦æ˜¾ç¤ºï¼Œæå‡å¯è¯»æ€§' }
        };
        
        const theme = themes[themeName];
        if (!theme) return;
        
        // åˆ›å»ºé€šçŸ¥å…ƒç´ 
        const notification = document.createElement('div');
        notification.className = 'theme-notification';
        notification.innerHTML = `
            <div class="theme-notification-content">
                <span class="theme-icon">${theme.icon}</span>
                <div class="theme-info">
                    <div class="theme-title">${theme.name}</div>
                    <div class="theme-desc">${theme.desc}</div>
                </div>
            </div>
        `;
        
        // æ·»åŠ é€šçŸ¥æ ·å¼ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
        if (!document.querySelector('#theme-notification-style')) {
            const style = document.createElement('style');
            style.id = 'theme-notification-style';
            style.textContent = `
                .theme-notification {
                    position: fixed;
                    bottom: 30px;
                    left: 50%;
                    transform: translateX(-50%) translateY(100px);
                    background: var(--bg-secondary);
                    border: 1px solid var(--primary-color);
                    border-radius: 25px;
                    padding: 1rem 1.5rem;
                    z-index: 1001;
                    box-shadow: var(--shadow-glow);
                    backdrop-filter: blur(10px);
                    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                    opacity: 0;
                }
                
                .theme-notification.show {
                    transform: translateX(-50%) translateY(0);
                    opacity: 1;
                }
                
                .theme-notification-content {
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                }
                
                .theme-icon {
                    font-size: 1.5rem;
                }
                
                .theme-info {
                    display: flex;
                    flex-direction: column;
                }
                
                .theme-title {
                    color: var(--text-primary);
                    font-weight: 600;
                    font-size: 0.95rem;
                }
                
                .theme-desc {
                    color: var(--text-secondary);
                    font-size: 0.8rem;
                    margin-top: 0.2rem;
                }
                
                @media (max-width: 480px) {
                    .theme-notification {
                        left: 10px;
                        right: 10px;
                        transform: translateY(100px);
                        max-width: calc(100vw - 20px);
                    }
                    
                    .theme-notification.show {
                        transform: translateY(0);
                    }
                    
                    .theme-desc {
                        display: none;
                    }
                }
            `;
            document.head.appendChild(style);
        }
        
        // æ˜¾ç¤ºé€šçŸ¥
        document.body.appendChild(notification);
        
        // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);
        
        // 2ç§’åéšè—
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 400);
        }, 2000);
    }
    
    // è·å–å½“å‰ä¸»é¢˜
    getCurrentTheme() {
        return this.currentTheme;
    }
    
    // å¾ªç¯åˆ‡æ¢ä¸»é¢˜ï¼ˆå¿«æ·é”®æ”¯æŒï¼‰
    cycleTheme() {
        const themes = ['dark', 'light', 'eye-care', 'warm', 'high-contrast'];
        const currentIndex = themes.indexOf(this.currentTheme);
        const nextIndex = (currentIndex + 1) % themes.length;
        this.setTheme(themes[nextIndex]);
    }
}

// å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
function setTheme(themeName) {
    if (window.themeSwitcher) {
        window.themeSwitcher.setTheme(themeName);
    }
}

// åˆå§‹åŒ–ä¸»é¢˜åˆ‡æ¢å™¨
document.addEventListener('DOMContentLoaded', function() {
    window.themeSwitcher = new ThemeSwitcher();
    
    // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ (Ctrl+Shift+T)
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'T') {
            e.preventDefault();
            window.themeSwitcher.cycleTheme();
        }
    });
});

// è®©Chart.jsç­‰ç¬¬ä¸‰æ–¹åº“æ„ŸçŸ¥ä¸»é¢˜å˜åŒ–
window.addEventListener('themeChanged', function(e) {
    // æ›´æ–°å›¾è¡¨é¢œè‰²ç­‰
    if (typeof Chart !== 'undefined' && Chart.instances) {
        Object.values(Chart.instances).forEach(chart => {
            if (chart && chart.options) {
                // æ›´æ–°å›¾è¡¨ä¸»é¢˜è‰²
                updateChartTheme(chart, e.detail.theme);
            }
        });
    }
});

function updateChartTheme(chart, theme) {
    // æ ¹æ®ä¸»é¢˜æ›´æ–°å›¾è¡¨é¢œè‰²
    const isDark = theme === 'dark' || theme === 'high-contrast';
    const textColor = isDark ? '#ffffff' : '#1e293b';
    const gridColor = isDark ? 'rgba(0, 212, 255, 0.1)' : 'rgba(0, 102, 204, 0.1)';
    
    if (chart.options.scales) {
        Object.keys(chart.options.scales).forEach(axis => {
            if (chart.options.scales[axis].ticks) {
                chart.options.scales[axis].ticks.color = textColor;
            }
            if (chart.options.scales[axis].grid) {
                chart.options.scales[axis].grid.color = gridColor;
            }
            if (chart.options.scales[axis].title) {
                chart.options.scales[axis].title.color = textColor;
            }
        });
    }
    
    if (chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels) {
        chart.options.plugins.legend.labels.color = textColor;
    }
    
    chart.update();
}
</script>