<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLOT.tab æ›²çº¿å›¾å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script>
        // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½æˆåŠŸï¼Œå¦‚æœå¤±è´¥åˆ™å°è¯•å¤‡ç”¨CDN
        window.addEventListener('load', function() {
            if (typeof Chart === 'undefined') {
                console.log('ä¸»CDNå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js';
                script.onload = function() {
                    console.log('å¤‡ç”¨CDNåŠ è½½æˆåŠŸ');
                    if (typeof Chart === 'undefined') {
                        showChartError();
                    }
                };
                script.onerror = function() {
                    console.log('å¤‡ç”¨CDNä¹Ÿå¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯');
                    showChartError();
                };
                document.head.appendChild(script);
            }
        });
        
        function showChartError() {
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.innerHTML = `
                <strong>å›¾è¡¨åº“åŠ è½½å¤±è´¥</strong><br>
                è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–ä¸‹è½½ç¦»çº¿ç‰ˆæœ¬ä½¿ç”¨ã€‚<br>
                <a href="https://github.com/chartjs/Chart.js/releases" target="_blank">ä¸‹è½½Chart.jsç¦»çº¿ç‰ˆæœ¬</a>
            `;
            errorDiv.style.display = 'block';
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        .drop-zone {
            border: 3px dashed #4CAF50;
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            background-color: white;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #45a049;
            background-color: #f9f9f9;
            transform: scale(1.02);
        }
        
        .drop-zone p {
            margin: 10px 0;
            font-size: 18px;
            color: #666;
        }
        
        .drop-zone .icon {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 20px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        .controls h3 {
            margin-top: 0;
            color: #333;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        
        .file-info {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background: #45a049;
        }
        
        .hidden {
            display: none !important;
        }
        
        .help-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .help-button:hover {
            background: #1976D2;
        }
        
        .help-panel {
            display: none;
            background: #f0f8ff;
            border: 1px solid #2196F3;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .help-panel h4 {
            margin: 0 0 10px 0;
            color: #1976D2;
        }
        
        .help-panel p {
            margin: 8px 0;
            line-height: 1.4;
            font-size: 14px;
        }
        
        .help-panel .filter-info {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .help-panel .filter-info:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .help-panel .highlight {
            background: #fff3cd;
            padding: 2px 4px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š æ•°æ®æ›²çº¿å›¾å·¥å…·</h1>
        <p>å°†æ‚¨çš„æ•°æ®æ–‡ä»¶æ‹–æ‹½åˆ°ä¸‹æ–¹åŒºåŸŸï¼Œè‡ªåŠ¨ç”Ÿæˆæ›²çº¿å›¾</p>
        <p><small>æ”¯æŒæ ¼å¼ï¼š.tab, .txt, .csv, .tsv, .dat</small></p>
    </div>

    <div class="drop-zone" id="dropZone">
        <div class="icon">ğŸ“</div>
        <p><strong>æ‹–æ‹½æ•°æ®æ–‡ä»¶åˆ°è¿™é‡Œ</strong></p>
        <p>æ”¯æŒ .tab/.txt/.csv/.tsv/.dat æ ¼å¼</p>
        <p>æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
        <input type="file" id="fileInput" accept=".tab,.txt,.csv,.tsv,.dat" style="display: none;">
    </div>

    <div class="error" id="errorDiv"></div>
    
    <div class="file-info" id="fileInfo"></div>

    <div class="controls" id="controls">
        <h3>å›¾è¡¨è®¾ç½®</h3>
        
        <div class="control-group">
            <label>é€‰æ‹©è¦æ˜¾ç¤ºçš„æ•°æ®åˆ—ï¼š
                <button type="button" class="help-button" onclick="toggleSelectAll()" id="selectAllBtn">âœ“ å…¨é€‰</button>
            </label>
            <div class="checkbox-group" id="columnCheckboxes"></div>
        </div>

        <div class="control-group">
            <label for="lineStyle">æ›²çº¿æ ·å¼ï¼š</label>
            <select id="lineStyle" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
                <option value="smooth">å¹³æ»‘æ›²çº¿ (æ¨è)</option>
                <option value="linear">ç›´çº¿è¿æ¥</option>
                <option value="stepped">é˜¶æ¢¯çŠ¶</option>
                <option value="points">ä»…æ˜¾ç¤ºæ•°æ®ç‚¹</option>
            </select>
        </div>

        <div class="control-group">
            <label>æ•°æ®æ»¤æ³¢å™¨ï¼š
                <button type="button" class="help-button" onclick="toggleFilterHelp()">â“ å¸®åŠ©</button>
            </label>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <input type="checkbox" id="enableFilter">
                <label for="enableFilter" style="margin: 0; font-weight: normal;">å¯ç”¨æ»¤æ³¢</label>
            </div>
            <div id="filterControls" style="display: none; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #f9f9f9;">
                <div style="margin-bottom: 10px;">
                    <label for="filterType">æ»¤æ³¢å™¨ç±»å‹ï¼š</label>
                    <select id="filterType" style="width: 100%; padding: 5px; margin-top: 5px;" onchange="updateFilterHelp()">
                        <option value="movingAverage">ç§»åŠ¨å¹³å‡æ»¤æ³¢</option>
                        <option value="gaussian">é«˜æ–¯æ»¤æ³¢</option>
                        <option value="butterworth">å·´ç‰¹æ²ƒæ–¯ä½é€šæ»¤æ³¢</option>
                        <option value="median">ä¸­å€¼æ»¤æ³¢</option>
                        <option value="kalman">ç®€å•å¡å°”æ›¼æ»¤æ³¢</option>
                    </select>
                </div>
                <div id="filterParams">
                    <label for="windowSize">çª—å£å¤§å°/å¼ºåº¦ï¼š</label>
                    <input type="range" id="windowSize" min="3" max="50" value="5" style="width: 100%;">
                    <span id="windowSizeValue">5</span>
                </div>
            </div>
            
            <!-- æ»¤æ³¢å™¨å¸®åŠ©é¢æ¿ -->
            <div id="filterHelpPanel" class="help-panel">
                <div id="movingAverageHelp" class="filter-info">
                    <h4>ğŸ“Š ç§»åŠ¨å¹³å‡æ»¤æ³¢</h4>
                    <p><strong>ç‰¹ç‚¹ï¼š</strong>ç®€å•æœ‰æ•ˆçš„å™ªå£°å¹³æ»‘ç®—æ³•ï¼Œé€šè¿‡è®¡ç®—é‚»è¿‘ç‚¹çš„å¹³å‡å€¼æ¥å‡å°‘éšæœºå™ªå£°ã€‚</p>
                    <p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
                    <p>â€¢ æ•°æ®æœ‰éšæœºå™ªå£°ä½†è¶‹åŠ¿æ˜æ˜¾</p>
                    <p>â€¢ éœ€è¦ç®€å•å¿«é€Ÿçš„å¹³æ»‘æ•ˆæœ</p>
                    <p>â€¢ ä¼ æ„Ÿå™¨æ•°æ®é¢„å¤„ç†</p>
                    <p><strong>çª—å£å¤§å°é€‰æ‹©ï¼š</strong></p>
                    <p>â€¢ <span class="highlight">3-7</span>ï¼šè½»å¾®å¹³æ»‘ï¼Œä¿æŒç»†èŠ‚</p>
                    <p>â€¢ <span class="highlight">8-15</span>ï¼šä¸­ç­‰å¹³æ»‘ï¼Œå¹³è¡¡å™ªå£°å’Œç»†èŠ‚</p>
                    <p>â€¢ <span class="highlight">16+</span>ï¼šå¼ºçƒˆå¹³æ»‘ï¼Œçªå‡ºä¸»è¦è¶‹åŠ¿</p>
                </div>
                
                <div id="gaussianHelp" class="filter-info">
                    <h4>ğŸ”” é«˜æ–¯æ»¤æ³¢</h4>
                    <p><strong>ç‰¹ç‚¹ï¼š</strong>åŸºäºé«˜æ–¯åˆ†å¸ƒçš„åŠ æƒå¹³å‡ï¼Œèƒ½æ›´å¥½åœ°ä¿æŒä¿¡å·çš„è¾¹ç¼˜ç‰¹å¾ï¼Œå¹³æ»‘æ•ˆæœè‡ªç„¶ã€‚</p>
                    <p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
                    <p>â€¢ éœ€è¦ä¿æŒä¿¡å·è¾¹ç¼˜å’Œç‰¹å¾ç‚¹</p>
                    <p>â€¢ å›¾åƒå¤„ç†æˆ–ç²¾å¯†æµ‹é‡æ•°æ®</p>
                    <p>â€¢ è¦æ±‚é«˜è´¨é‡å¹³æ»‘æ•ˆæœ</p>
                    <p><strong>å¼ºåº¦é€‰æ‹©ï¼š</strong></p>
                    <p>â€¢ <span class="highlight">3-8</span>ï¼šè½»å¾®å¹³æ»‘ï¼Œä¿æŒåŸå§‹ç‰¹å¾</p>
                    <p>â€¢ <span class="highlight">9-20</span>ï¼šé€‚ä¸­å¹³æ»‘ï¼Œå»é™¤ä¸­é¢‘å™ªå£°</p>
                    <p>â€¢ <span class="highlight">21+</span>ï¼šå¼ºçƒˆå¹³æ»‘ï¼Œä»…ä¿ç•™ä¸»è¦è¶‹åŠ¿</p>
                </div>
                
                <div id="butterworthHelp" class="filter-info">
                    <h4>ğŸŒŠ å·´ç‰¹æ²ƒæ–¯ä½é€šæ»¤æ³¢</h4>
                    <p><strong>ç‰¹ç‚¹ï¼š</strong>ç»å…¸çš„é¢‘åŸŸæ»¤æ³¢å™¨ï¼Œèƒ½æœ‰æ•ˆå»é™¤é«˜é¢‘å™ªå£°ï¼Œä¿æŒä½é¢‘ä¿¡å·å®Œæ•´æ€§ã€‚</p>
                    <p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
                    <p>â€¢ ä¿¡å·å¤„ç†å’Œé¢‘è°±åˆ†æ</p>
                    <p>â€¢ å»é™¤å·²çŸ¥é¢‘ç‡èŒƒå›´çš„å™ªå£°</p>
                    <p>â€¢ æŒ¯åŠ¨ã€å£°å­¦æ•°æ®å¤„ç†</p>
                    <p><strong>å¼ºåº¦é€‰æ‹©ï¼š</strong></p>
                    <p>â€¢ <span class="highlight">5-15</span>ï¼šä¿ç•™æ›´å¤šé«˜é¢‘æˆåˆ†</p>
                    <p>â€¢ <span class="highlight">16-30</span>ï¼šå¹³è¡¡çš„é¢‘ç‡å“åº”</p>
                    <p>â€¢ <span class="highlight">31+</span>ï¼šå¼ºçƒˆæŠ‘åˆ¶é«˜é¢‘å™ªå£°</p>
                </div>
                
                <div id="medianHelp" class="filter-info">
                    <h4>âš¡ ä¸­å€¼æ»¤æ³¢</h4>
                    <p><strong>ç‰¹ç‚¹ï¼š</strong>å–çª—å£å†…æ•°å€¼çš„ä¸­ä½æ•°ï¼Œèƒ½æœ‰æ•ˆå»é™¤è„‰å†²å™ªå£°å’Œå¼‚å¸¸å€¼ï¼ŒåŒæ—¶ä¿æŒè¾¹ç¼˜ã€‚</p>
                    <p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
                    <p>â€¢ æ•°æ®æœ‰å°–å³°å™ªå£°æˆ–å¼‚å¸¸å€¼</p>
                    <p>â€¢ éœ€è¦ä¿æŒä¿¡å·è·³å˜è¾¹ç¼˜</p>
                    <p>â€¢ æ•°å­—å›¾åƒå»å™ª</p>
                    <p><strong>çª—å£å¤§å°é€‰æ‹©ï¼š</strong></p>
                    <p>â€¢ <span class="highlight">3-5</span>ï¼šå»é™¤å°çš„å¼‚å¸¸ç‚¹</p>
                    <p>â€¢ <span class="highlight">6-12</span>ï¼šå¤„ç†ä¸­ç­‰è„‰å†²å™ªå£°</p>
                    <p>â€¢ <span class="highlight">13+</span>ï¼šå»é™¤å¤§èŒƒå›´å¼‚å¸¸åŒºåŸŸ</p>
                </div>
                
                <div id="kalmanHelp" class="filter-info">
                    <h4>ğŸ¯ ç®€å•å¡å°”æ›¼æ»¤æ³¢</h4>
                    <p><strong>ç‰¹ç‚¹ï¼š</strong>åŸºäºçŠ¶æ€ä¼°è®¡çš„è‡ªé€‚åº”æ»¤æ³¢å™¨ï¼Œèƒ½æ ¹æ®ä¿¡å·å˜åŒ–åŠ¨æ€è°ƒæ•´æ»¤æ³¢å¼ºåº¦ã€‚</p>
                    <p><strong>é€‚ç”¨åœºæ™¯ï¼š</strong></p>
                    <p>â€¢ åŠ¨æ€ç³»ç»ŸçŠ¶æ€ä¼°è®¡</p>
                    <p>â€¢ ä¼ æ„Ÿå™¨èåˆå’Œå¯¼èˆª</p>
                    <p>â€¢ éœ€è¦è·Ÿè¸ªä¿¡å·å˜åŒ–è¶‹åŠ¿</p>
                    <p><strong>è¿‡ç¨‹å™ªå£°é€‰æ‹©ï¼š</strong></p>
                    <p>â€¢ <span class="highlight">5-15</span>ï¼šä¿¡å·å˜åŒ–è¾ƒæ…¢</p>
                    <p>â€¢ <span class="highlight">16-30</span>ï¼šä¸­ç­‰åŠ¨æ€ç‰¹æ€§</p>
                    <p>â€¢ <span class="highlight">31+</span>ï¼šå¿«é€Ÿå˜åŒ–çš„åŠ¨æ€ä¿¡å·</p>
                </div>
                
                <div style="background: #e8f4f8; padding: 10px; border-radius: 5px; margin-top: 15px;">
                    <h4>ğŸ’¡ é€‰æ‹©å»ºè®®</h4>
                    <p><strong>å™ªå£°ç±»å‹è¯†åˆ«ï¼š</strong></p>
                    <p>â€¢ éšæœºå™ªå£° â†’ ç§»åŠ¨å¹³å‡æˆ–é«˜æ–¯æ»¤æ³¢</p>
                    <p>â€¢ è„‰å†²å™ªå£° â†’ ä¸­å€¼æ»¤æ³¢</p>
                    <p>â€¢ é«˜é¢‘å™ªå£° â†’ å·´ç‰¹æ²ƒæ–¯æ»¤æ³¢</p>
                    <p>â€¢ åŠ¨æ€ä¿¡å· â†’ å¡å°”æ›¼æ»¤æ³¢</p>
                </div>
            </div>
        </div>
        
        <div class="control-group">
            <label for="chartTitle">å›¾è¡¨æ ‡é¢˜ï¼š</label>
            <input type="text" id="chartTitle" value="æ•°æ®æ›²çº¿å›¾" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
        </div>
        
        <button onclick="updateChart()">æ›´æ–°å›¾è¡¨</button>
    </div>

    <div class="chart-container" id="chartContainer">
        <canvas id="chart"></canvas>
    </div>

    <script>
        let fileData = null;
        let chart = null;
        let originalData = null; // ä¿å­˜åŸå§‹æ•°æ®
        
        // æ»¤æ³¢å™¨å®ç°
        const Filters = {
            // ç§»åŠ¨å¹³å‡æ»¤æ³¢
            movingAverage: function(data, windowSize) {
                const result = [];
                const halfWindow = Math.floor(windowSize / 2);
                
                for (let i = 0; i < data.length; i++) {
                    let sum = 0;
                    let count = 0;
                    
                    for (let j = Math.max(0, i - halfWindow); j <= Math.min(data.length - 1, i + halfWindow); j++) {
                        sum += data[j];
                        count++;
                    }
                    
                    result.push(sum / count);
                }
                
                return result;
            },
            
            // é«˜æ–¯æ»¤æ³¢
            gaussian: function(data, sigma) {
                const kernelSize = Math.max(3, Math.ceil(sigma * 3) * 2 + 1);
                const kernel = [];
                const halfKernel = Math.floor(kernelSize / 2);
                let kernelSum = 0;
                
                // ç”Ÿæˆé«˜æ–¯æ ¸
                for (let i = 0; i < kernelSize; i++) {
                    const x = i - halfKernel;
                    const value = Math.exp(-(x * x) / (2 * sigma * sigma));
                    kernel.push(value);
                    kernelSum += value;
                }
                
                // å½’ä¸€åŒ–æ ¸
                for (let i = 0; i < kernel.length; i++) {
                    kernel[i] /= kernelSum;
                }
                
                const result = [];
                for (let i = 0; i < data.length; i++) {
                    let sum = 0;
                    let weightSum = 0;
                    
                    for (let j = 0; j < kernelSize; j++) {
                        const dataIndex = i - halfKernel + j;
                        if (dataIndex >= 0 && dataIndex < data.length) {
                            sum += data[dataIndex] * kernel[j];
                            weightSum += kernel[j];
                        }
                    }
                    
                    result.push(sum / weightSum);
                }
                
                return result;
            },
            
            // ç®€å•ä½é€šæ»¤æ³¢å™¨ï¼ˆå·´ç‰¹æ²ƒæ–¯è¿‘ä¼¼ï¼‰
            butterworth: function(data, alpha) {
                alpha = Math.max(0.01, Math.min(0.99, alpha / 50)); // è°ƒæ•´å‚æ•°èŒƒå›´
                const result = [data[0]];
                
                for (let i = 1; i < data.length; i++) {
                    result.push(alpha * data[i] + (1 - alpha) * result[i - 1]);
                }
                
                return result;
            },
            
            // ä¸­å€¼æ»¤æ³¢
            median: function(data, windowSize) {
                const result = [];
                const halfWindow = Math.floor(windowSize / 2);
                
                for (let i = 0; i < data.length; i++) {
                    const window = [];
                    
                    for (let j = Math.max(0, i - halfWindow); j <= Math.min(data.length - 1, i + halfWindow); j++) {
                        window.push(data[j]);
                    }
                    
                    window.sort((a, b) => a - b);
                    const median = window[Math.floor(window.length / 2)];
                    result.push(median);
                }
                
                return result;
            },
            
            // ç®€å•å¡å°”æ›¼æ»¤æ³¢
            kalman: function(data, processNoise) {
                processNoise = processNoise / 1000; // è°ƒæ•´å™ªå£°å‚æ•°
                const measurementNoise = 0.1;
                
                let estimate = data[0];
                let errorEstimate = 1.0;
                const result = [estimate];
                
                for (let i = 1; i < data.length; i++) {
                    // é¢„æµ‹
                    const prediction = estimate;
                    const predictionError = errorEstimate + processNoise;
                    
                    // æ›´æ–°
                    const kalmanGain = predictionError / (predictionError + measurementNoise);
                    estimate = prediction + kalmanGain * (data[i] - prediction);
                    errorEstimate = (1 - kalmanGain) * predictionError;
                    
                    result.push(estimate);
                }
                
                return result;
            }
        };
        
        // åˆå§‹åŒ–æ§åˆ¶å™¨
        document.addEventListener('DOMContentLoaded', function() {
            const enableFilter = document.getElementById('enableFilter');
            const filterControls = document.getElementById('filterControls');
            const windowSize = document.getElementById('windowSize');
            const windowSizeValue = document.getElementById('windowSizeValue');
            
            enableFilter.addEventListener('change', function() {
                filterControls.style.display = this.checked ? 'block' : 'none';
            });
            
            windowSize.addEventListener('input', function() {
                windowSizeValue.textContent = this.value;
            });
            
            // åˆå§‹åŒ–å¸®åŠ©é¢æ¿
            updateFilterHelp();
        });
        
        // åˆ‡æ¢å¸®åŠ©é¢æ¿æ˜¾ç¤º
        function toggleFilterHelp() {
            const helpPanel = document.getElementById('filterHelpPanel');
            const isVisible = helpPanel.style.display === 'block';
            helpPanel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                updateFilterHelp();
            }
        }
        
        // å…¨é€‰/å…¨ä¸é€‰åŠŸèƒ½
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
            const selectAllBtn = document.getElementById('selectAllBtn');
            
            if (checkboxes.length === 0) return;
            
            // æ£€æŸ¥å½“å‰çŠ¶æ€
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const shouldSelectAll = checkedCount < checkboxes.length;
            
            // è®¾ç½®æ‰€æœ‰å¤é€‰æ¡†çŠ¶æ€
            checkboxes.forEach(cb => {
                cb.checked = shouldSelectAll;
            });
            
            // æ›´æ–°æŒ‰é’®æ–‡å­—
            selectAllBtn.textContent = shouldSelectAll ? 'âœ— å…¨ä¸é€‰' : 'âœ“ å…¨é€‰';
        }
        
        // æ ¹æ®é€‰æ‹©çš„æ»¤æ³¢å™¨æ›´æ–°å¸®åŠ©å†…å®¹
        function updateFilterHelp() {
            const filterType = document.getElementById('filterType').value;
            const allHelps = document.querySelectorAll('.filter-info');
            
            // éšè—æ‰€æœ‰å¸®åŠ©ä¿¡æ¯
            allHelps.forEach(help => {
                help.style.display = 'none';
            });
            
            // æ˜¾ç¤ºå½“å‰é€‰æ‹©æ»¤æ³¢å™¨çš„å¸®åŠ©
            const currentHelp = document.getElementById(filterType + 'Help');
            if (currentHelp) {
                currentHelp.style.display = 'block';
            }
            
            // å§‹ç»ˆæ˜¾ç¤ºé€‰æ‹©å»ºè®®
            const suggestions = document.querySelector('#filterHelpPanel > div:last-child');
            if (suggestions) {
                suggestions.style.display = 'block';
            }
        }
        
        // æ‹–æ‹½å¤„ç†
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        function showError(message) {
            const errorDiv = document.getElementById('errorDiv');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('errorDiv').style.display = 'none';
        }
        
        function handleFile(file) {
            hideError();
            
            // æ”¯æŒæ›´å¤šæ–‡ä»¶ç±»å‹
            const supportedExtensions = ['.tab', '.txt', '.csv', '.tsv', '.dat'];
            const fileName = file.name.toLowerCase();
            const isSupported = supportedExtensions.some(ext => fileName.endsWith(ext));
            
            if (!isSupported) {
                showError(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹ã€‚æ”¯æŒçš„æ ¼å¼: ${supportedExtensions.join(', ')}`);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    parseFile(e.target.result, file.name);
                } catch (error) {
                    showError('æ–‡ä»¶è§£æå¤±è´¥: ' + error.message);
                    console.error('è§£æé”™è¯¯è¯¦æƒ…:', error);
                }
            };
            reader.readAsText(file);
        }
        
        function parseFile(content, filename) {
            // å¤„ç†ä¸åŒç±»å‹çš„æ¢è¡Œç¬¦
            const lines = content.trim().split(/\r?\n/);
            
            if (lines.length < 2) {
                throw new Error('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼Œæ–‡ä»¶å†…å®¹è¿‡å°‘');
            }
            
            let headerLine = -1;
            let headers = [];
            
            // æ™ºèƒ½æ£€æµ‹è¡¨å¤´è¡Œ
            for (let i = 0; i < Math.min(lines.length, 10); i++) {
                const line = lines[i].trim();
                
                // è·³è¿‡ç©ºè¡Œå’Œçº¯æ•°å­—è¡Œ
                if (!line || /^\d+$/.test(line) || line.startsWith('"HQ_') || line.startsWith('HQ_')) {
                    continue;
                }
                
                // æ£€æµ‹æ˜¯å¦åŒ…å«å­—æ¯ï¼ˆå¯èƒ½æ˜¯è¡¨å¤´ï¼‰
                if (/[a-zA-Z]/.test(line)) {
                    // å°è¯•è§£æè¿™ä¸€è¡Œä½œä¸ºè¡¨å¤´
                    let potentialHeaders;
                    
                    // å…ˆå°è¯•åˆ¶è¡¨ç¬¦åˆ†éš”
                    if (line.includes('\t')) {
                        potentialHeaders = line.split('\t');
                    } else if (line.includes(',')) {
                        // å°è¯•é€—å·åˆ†éš”
                        potentialHeaders = line.split(',');
                    } else if (line.includes(' ')) {
                        // å°è¯•ç©ºæ ¼åˆ†éš”
                        potentialHeaders = line.split(/\s+/);
                    } else {
                        continue;
                    }
                    
                    // æ¸…ç†è¡¨å¤´ï¼šå»é™¤å¼•å·ã€ç©ºæ ¼ç­‰
                    const cleanHeaders = potentialHeaders.map(h => {
                        return h.trim()
                                .replace(/^["']|["']$/g, '') // å»é™¤å¼€å¤´ç»“å°¾çš„å¼•å·
                                .replace(/[^\w\s-_.]/g, '') // å»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œä¿ç•™å­—æ¯æ•°å­—ä¸‹åˆ’çº¿ç‚¹æ¨ªçº¿
                                .trim();
                    }).filter(h => h.length > 0);
                    
                    if (cleanHeaders.length >= 2) {
                        headerLine = i;
                        headers = cleanHeaders;
                        console.log(`æ£€æµ‹åˆ°è¡¨å¤´åœ¨ç¬¬${i+1}è¡Œ:`, headers);
                        break;
                    }
                }
            }
            
            if (headerLine === -1 || headers.length === 0) {
                throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„è¡¨å¤´è¡Œï¼Œè¯·ç¡®ä¿æ–‡ä»¶åŒ…å«åˆ—å');
            }
            
            // ä»è¡¨å¤´è¡Œä¹‹åå¼€å§‹è§£ææ•°æ®
            const data = [];
            let validDataCount = 0;
            
            for (let i = headerLine + 1; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // è·³è¿‡ç©ºè¡Œ
                if (!line) continue;
                
                // æ™ºèƒ½æ£€æµ‹åˆ†éš”ç¬¦
                let values;
                if (line.includes('\t')) {
                    values = line.split('\t');
                } else if (line.includes(',')) {
                    values = line.split(',');
                } else {
                    values = line.split(/\s+/);
                }
                
                // æ£€æŸ¥æ•°æ®è¡Œæ˜¯å¦æœ‰æ•ˆï¼ˆè‡³å°‘åŒ…å«ä¸€äº›æ•°å­—ï¼‰
                const numericValues = values.filter(v => {
                    const cleaned = v.trim().replace(/^["']|["']$/g, '');
                    return !isNaN(parseFloat(cleaned)) && isFinite(cleaned);
                });
                
                if (numericValues.length >= Math.min(2, headers.length)) {
                    const row = {};
                    let validColumns = 0;
                    
                    headers.forEach((header, index) => {
                        if (index < values.length) {
                            const cleanValue = values[index].trim().replace(/^["']|["']$/g, '');
                            const numValue = parseFloat(cleanValue);
                            
                            if (!isNaN(numValue) && isFinite(numValue)) {
                                row[header] = numValue;
                                validColumns++;
                            } else {
                                row[header] = 0; // é»˜è®¤å€¼
                            }
                        } else {
                            row[header] = 0;
                        }
                    });
                    
                    if (validColumns >= 1) {
                        data.push(row);
                        validDataCount++;
                    }
                }
                
                // é™åˆ¶å¤„ç†è¡Œæ•°ï¼Œé¿å…è¿‡å¤§æ–‡ä»¶å¡é¡¿
                if (validDataCount > 10000) {
                    console.warn('æ•°æ®è¡Œæ•°è¶…è¿‡10000è¡Œï¼Œå·²æˆªæ–­æ˜¾ç¤º');
                    break;
                }
            }
            
            if (data.length === 0) {
                throw new Error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®è¡Œï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼');
            }
            
            console.log(`æˆåŠŸè§£æ: ${headers.length}åˆ—, ${data.length}è¡Œæ•°æ®`);
            
            fileData = { headers, data, filename };
            originalData = JSON.parse(JSON.stringify(data)); // æ·±æ‹·è´åŸå§‹æ•°æ®
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.innerHTML = `
                <strong>æ–‡ä»¶:</strong> ${filename}<br>
                <strong>åˆ—æ•°:</strong> ${headers.length}<br>
                <strong>æ•°æ®è¡Œæ•°:</strong> ${data.length}<br>
                <strong>åˆ—å:</strong> ${headers.join(', ')}
            `;
            fileInfo.style.display = 'block';
            
            // åˆ›å»ºåˆ—é€‰æ‹©å¤é€‰æ¡†
            createColumnCheckboxes();
            
            // æ˜¾ç¤ºæ§ä»¶å’Œå›¾è¡¨
            document.getElementById('controls').style.display = 'block';
            document.getElementById('chartContainer').style.display = 'block';
            
            // ç”Ÿæˆåˆå§‹å›¾è¡¨
            updateChart();
        }
        
        function createColumnCheckboxes() {
            const container = document.getElementById('columnCheckboxes');
            container.innerHTML = '';
            
            // å‡è®¾ç¬¬ä¸€åˆ—æ˜¯æ—¶é—´/Xè½´ï¼Œé»˜è®¤ä¸æ˜¾ç¤ºåœ¨é€‰é¡¹ä¸­
            const timeColumn = fileData.headers[0];
            
            fileData.headers.slice(1).forEach((header, index) => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `col_${index}`;
                checkbox.value = header;
                checkbox.checked = true; // é»˜è®¤å…¨é€‰
                
                // æ·»åŠ çŠ¶æ€å˜åŒ–ç›‘å¬å™¨
                checkbox.addEventListener('change', updateSelectAllButtonState);
                
                const label = document.createElement('label');
                label.htmlFor = `col_${index}`;
                label.textContent = header;
                label.style.fontWeight = 'normal';
                label.style.marginBottom = '0';
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
            
            // åˆå§‹åŒ–å…¨é€‰æŒ‰é’®çŠ¶æ€
            updateSelectAllButtonState();
        }
        
        // æ›´æ–°å…¨é€‰æŒ‰é’®çŠ¶æ€
        function updateSelectAllButtonState() {
            const checkboxes = document.querySelectorAll('#columnCheckboxes input[type="checkbox"]');
            const selectAllBtn = document.getElementById('selectAllBtn');
            
            if (checkboxes.length === 0) return;
            
            const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
            const allSelected = checkedCount === checkboxes.length;
            
            selectAllBtn.textContent = allSelected ? 'âœ— å…¨ä¸é€‰' : 'âœ“ å…¨é€‰';
        }
        
        function updateChart() {
            if (!fileData) return;
            
            // æ£€æŸ¥Chart.jsæ˜¯å¦å¯ç”¨
            if (typeof Chart === 'undefined') {
                showError('å›¾è¡¨åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥');
                return;
            }
            
            const selectedColumns = Array.from(document.querySelectorAll('#columnCheckboxes input:checked'))
                .map(cb => cb.value);
            
            if (selectedColumns.length === 0) {
                showError('è¯·è‡³å°‘é€‰æ‹©ä¸€åˆ—æ•°æ®');
                return;
            }
            
            hideError();
            
            const ctx = document.getElementById('chart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }
            
            // è·å–æ»¤æ³¢è®¾ç½®
            const enableFilter = document.getElementById('enableFilter').checked;
            const filterType = document.getElementById('filterType').value;
            const windowSize = parseInt(document.getElementById('windowSize').value);
            
            // è·å–æ›²çº¿æ ·å¼
            const lineStyle = document.getElementById('lineStyle').value;
            
            // å‡†å¤‡æ•°æ®
            const timeColumn = fileData.headers[0];
            let currentData = originalData;
            
            // åº”ç”¨æ»¤æ³¢å™¨
            if (enableFilter) {
                currentData = originalData.map(row => ({ ...row })); // å¤åˆ¶æ•°æ®
                
                selectedColumns.forEach(column => {
                    const originalValues = originalData.map(row => row[column]);
                    let filteredValues;
                    
                    switch (filterType) {
                        case 'movingAverage':
                            filteredValues = Filters.movingAverage(originalValues, windowSize);
                            break;
                        case 'gaussian':
                            filteredValues = Filters.gaussian(originalValues, windowSize / 3);
                            break;
                        case 'butterworth':
                            filteredValues = Filters.butterworth(originalValues, windowSize);
                            break;
                        case 'median':
                            filteredValues = Filters.median(originalValues, windowSize);
                            break;
                        case 'kalman':
                            filteredValues = Filters.kalman(originalValues, windowSize);
                            break;
                        default:
                            filteredValues = originalValues;
                    }
                    
                    // æ›´æ–°æ•°æ®
                    currentData.forEach((row, index) => {
                        row[column] = filteredValues[index];
                    });
                });
            }
            
            const labels = currentData.map(row => row[timeColumn]);
            
            // æ ¹æ®æ›²çº¿æ ·å¼é…ç½®Chart.jsé€‰é¡¹
            let chartType = 'line';
            let pointRadius = 0;
            let borderWidth = 2;
            let tension = 0.4; // å¹³æ»‘æ›²çº¿
            let stepped = false;
            let showLine = true;
            
            switch (lineStyle) {
                case 'smooth':
                    tension = 0.4;
                    pointRadius = 0;
                    break;
                case 'linear':
                    tension = 0;
                    pointRadius = 0;
                    break;
                case 'stepped':
                    tension = 0;
                    stepped = true;
                    pointRadius = 0;
                    break;
                case 'points':
                    pointRadius = 3;
                    borderWidth = 0;
                    showLine = false;
                    break;
            }
            
            const datasets = selectedColumns.map((column, index) => ({
                label: column + (enableFilter ? ` (${getFilterName(filterType)})` : ''),
                data: currentData.map(row => row[column]),
                borderColor: getChartColor(index),
                backgroundColor: getChartColor(index),
                borderWidth: borderWidth,
                pointRadius: pointRadius,
                pointHoverRadius: pointRadius > 0 ? pointRadius + 2 : 4,
                fill: false,
                tension: tension,
                stepped: stepped,
                showLine: showLine
            }));
            
            const chartTitle = document.getElementById('chartTitle').value || 'æ•°æ®æ›²çº¿å›¾';
            
            chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: chartTitle,
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: timeColumn
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'æ•°å€¼'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }
        
        function getFilterName(filterType) {
            const names = {
                'movingAverage': 'ç§»åŠ¨å¹³å‡',
                'gaussian': 'é«˜æ–¯',
                'butterworth': 'å·´ç‰¹æ²ƒæ–¯',
                'median': 'ä¸­å€¼',
                'kalman': 'å¡å°”æ›¼'
            };
            return names[filterType] || filterType;
        }
        
        function getChartColor(index) {
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ];
            return colors[index % colors.length];
        }
    </script>
</body>
</html>